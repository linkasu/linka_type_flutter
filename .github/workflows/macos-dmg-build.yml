name: macOS DMG Build

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build macOS app
      run: flutter build macos --release
      
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Create DMG directory structure
      run: |
        mkdir -p dmg_build
        cp -r build/macos/Build/Products/Release/LINKa\ Ð½Ð°Ð¿Ð¸ÑˆÐ¸.app dmg_build/
        
    - name: Create DMG
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ DMG
        hdiutil create -srcfolder dmg_build -volname "LINKa Ð½Ð°Ð¿Ð¸ÑˆÐ¸" -fs HFS+ -fsargs "-c c=64,a=16,e=16" -format UDRW -size 200m temp.dmg
        
        # ÐœÐ¾Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ DMG
        device=$(hdiutil attach -readwrite -noverify -noautoopen "temp.dmg" | egrep '^/dev/' | sed 1q | awk '{print $1}')
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Applications
        ln -s /Applications "/Volumes/LINKa Ð½Ð°Ð¿Ð¸ÑˆÐ¸/Applications"
        
        # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
        chmod -Rf 755 "/Volumes/LINKa Ð½Ð°Ð¿Ð¸ÑˆÐ¸"
        
        # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ DMG
        hdiutil detach "$device"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¶Ð°Ñ‚Ñ‹Ð¹ DMG
        hdiutil convert "temp.dmg" -format UDZO -imagekey zlib-level=9 -o "LINKa-napishi-${{ steps.version.outputs.version }}.dmg"
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
        rm temp.dmg
        
    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: LINKa-napishi-${{ steps.version.outputs.version }}.dmg
        
    - name: Get Release
      id: get_release
      uses: actions/github-script@v7
      with:
        script: |
          const release = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: context.ref.replace('refs/tags/', '')
          });
          core.setOutput('upload_url', release.data.upload_url);
          return release.data;
        
    - name: Upload Release Asset
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release.outputs.upload_url }}
        asset_path: LINKa-napishi-${{ steps.version.outputs.version }}.dmg
        asset_name: LINKa-napishi-${{ steps.version.outputs.version }}.dmg
        asset_content_type: application/octet-stream
        
    - name: Create Release Summary
      if: github.event_name == 'release'
      run: |
        echo "## macOS DMG Installer" >> $GITHUB_STEP_SUMMARY
        echo "âœ… macOS DMG installer created successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ File: LINKa-napishi-${{ steps.version.outputs.version }}.dmg" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ Includes: Flutter app, all dependencies, drag-to-install" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Publisher: linka.su" >> $GITHUB_STEP_SUMMARY
